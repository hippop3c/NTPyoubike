<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouBike 2.0 新北市｜即時場站資訊（自動更新）</title>
  <meta name="description" content="YouBike 2.0 新北市即時場站資訊查詢，支援關鍵字與行政區篩選、欄位排序、地圖標記（顯示可借/可還），並可自動更新。" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <!-- Styles -->
  <style>
    :root{ --bg:#0b1020; --card:#111730; --muted:#9aa3b2; --text:#eaf0ff; --good:#32d296; --warn:#ffb800; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"PingFang TC","Microsoft JhengHei",sans-serif; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; backdrop-filter:saturate(150%) blur(8px); background:linear-gradient(180deg, rgba(11,16,32,.9), rgba(11,16,32,.6)); border-bottom:1px solid rgba(255,255,255,.06); z-index:10}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    h1{font-size:20px; margin:0 0 6px 0}
    .controls{display:grid; gap:8px; grid-template-columns: 1fr 160px 160px 160px}
    .controls > *{background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px}
    .controls input,.controls select{width:100%; background:transparent; color:inherit; border:none; outline:none; font-size:14px}
    .meta{display:flex; gap:12px; align-items:center; font-size:12px; color:var(--muted); margin-top:6px; flex-wrap:wrap}
    .pill{padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.06)}
    .pill.button{cursor:pointer}
    .grid{margin-top:12px; background:var(--card); border-radius:16px; border:1px solid rgba(255,255,255,.08); overflow:hidden}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead{background:rgba(255,255,255,.04)}
    th,td{padding:10px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,.06)}
    th button{background:transparent; border:none; color:inherit; font:inherit; display:flex; align-items:center; gap:6px; cursor:pointer}
    tr:hover td{background:rgba(255,255,255,.02)}
    .footer{font-size:12px; color:var(--muted); padding:16px}
    .hidden{display:none}
    #map{height:60vh; width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:#0a0f1f; margin:12px 0 16px}
    .icon-dot{display:grid; place-items:center; width:32px; height:32px; border-radius:50%; font-weight:700; font-size:11px; color:#0b1020; border:2px solid rgba(0,0,0,.25); line-height:1}
    .icon-dot .pair{display:inline-block; transform:translateY(1px);} .icon-dot .pair b{font-weight:800}
    .icon-dot.good{background:var(--good)} .icon-dot.mid{background:var(--warn)} .icon-dot.bad{background:var(--bad)}
    @media (max-width: 900px){ .controls{grid-template-columns: 1fr 1fr} }
    .statusbar{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04); font-size:13px}
  </style>
  <!-- Leaflet JS FIRST (defer) -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <!-- App script (defer) -->
  <script defer>
  // ========= Config =========
  const API = 'https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json?page=0&size=10000';
  const API_FALLBACK = 'https://cors.isomorphic-git.org/' + API;

  // ========= DOM =========
  const el = (id)=>document.getElementById(id);
  let raw=[], view=[], timer=null, sortKey='sarea', sortAsc=true;

  window.addEventListener('DOMContentLoaded', () => {
    const tbody = el('tbody');
    const lastUpdate = el('lastUpdate');
    const count = el('count');
    const q = el('q');
    const district = el('district');
    const statusSel = el('status');
    const intervalSel = el('interval');
    const manualBtn = el('manualBtn');

    // Guard: check Leaflet existence
    if (typeof L === 'undefined') {
      alert('Leaflet 載入失敗：請檢查公司防火牆或瀏覽器阻擋 CDN。');
      return;
    }

    // Map
    const map = L.map('map', { zoomControl:true, attributionControl:true }).setView([25.013,121.465], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    function fmtTime(s){ if(!s) return '—'; const str=String(s); if(/^\d{14}$/.test(str)){ const y=str.slice(0,4),mo=str.slice(4,6),d=str.slice(6,8),h=str.slice(8,10),mi=str.slice(10,12),se=str.slice(12,14); return new Date(`${y}-${mo}-${d}T${h}:${mi}:${se}+08:00`).toLocaleString('zh-TW',{hour12:false}); } return s; }
    function pct(a,b){ return b>0 ? (a*100/b) : 0 }
    function ratioClass(r){ if(r>=40) return 'good'; if(r>=15) return 'mid'; return 'bad'; }

    function render(){
      const kw = q.value.trim().toLowerCase();
      const dist = district.value;
      const st = statusSel.value;
      view = raw.filter(r=>{
        if(dist && r.sarea!==dist) return false;
        if(st==='open' && r.act!=='1') return false;
        if(st==='closed' && r.act==='1') return false;
        if(!kw) return true;
        const hay = `${r.sno}|${r.sna}|${r.ar||''}`.toLowerCase();
        return hay.includes(kw);
      });
      view.sort((a,b)=>{
        const k=sortKey;
        let va=(k==='ratio')?(Number(a.sbi)||0)/(Number(a.tot)||1):a[k];
        let vb=(k==='ratio')?(Number(b.sbi)||0)/(Number(b.tot)||1):b[k];
        if(typeof va==='string' && typeof vb==='string'){ return sortAsc?va.localeCompare(vb,'zh-Hant'):vb.localeCompare(va,'zh-Hant'); }
        va=Number(va)||0; vb=Number(vb)||0; return sortAsc?va-vb:vb-va;
      });
      // table
      tbody.innerHTML='';
      for(const r of view){
        const tot=Number(r.tot)||0, sbi=Number(r.sbi)||0, bemp=Number(r.bemp)||0, ratio=pct(sbi,tot);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.sno}</td><td>${r.sna}</td><td>${r.sarea}</td><td>${sbi}</td><td>${bemp}</td><td>${tot}</td><td class="ratio ${ratioClass(ratio)}">${ratio.toFixed(0)}%</td><td>${fmtTime(r.mday)}</td><td>${r.ar||''}</td><td>${r.act==='1'?'營運中':'暫停'}</td>`;
        tbody.appendChild(tr);
      }
      el('empty').classList.toggle('hidden', view.length>0);
      count.textContent = `筆數：${view.length}`;
      // district options
      if(district.options.length<=1 && raw.length){
        const areas=[...new Set(raw.map(d=>d.sarea))].sort((a,b)=>a.localeCompare(b,'zh-Hant'));
        for(const a of areas){ const o=document.createElement('option'); o.value=a; o.textContent=a; district.appendChild(o); }
      }
      updateMap();
    }

    async function tryFetch(url){
      const res = await fetch(url, { cache:'no-store', mode:'cors' });
      if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const payload = await res.json().catch(async()=>JSON.parse(await res.text()));
      return Array.isArray(payload) ? payload : (payload?.data || []);
    }

    async function fetchData(){
      try{
        raw = await tryFetch(API);
        if(!raw.length){ raw = await tryFetch(API_FALLBACK); }
      }catch(e){
        try{ raw = await tryFetch(API_FALLBACK); }
        catch(e2){ lastUpdate.textContent = '更新失敗：' + (e2.message||e.message); return; }
      }
      render();
      lastUpdate.textContent = '最後更新：' + new Date().toLocaleString('zh-TW',{hour12:false});
    }

    function setTimer(){ if(timer) clearInterval(timer); const sec = Number(intervalSel.value); if(sec>0){ timer=setInterval(fetchData, sec*1000); } }

    q.addEventListener('input', render);
    district.addEventListener('change', render);
    statusSel.addEventListener('change', render);
    intervalSel.addEventListener('change', setTimer);
    manualBtn.addEventListener('click', fetchData);

    document.querySelectorAll('th button[data-sort]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const k=btn.getAttribute('data-sort'); if(sortKey===k){ sortAsc=!sortAsc; } else { sortKey=k; sortAsc=true; } render(); });
    });

    fetchData();
    setTimer();

    function updateMap(){
      markerLayer.clearLayers();
      if(!view.length) return;
      const markers=[];
      for(const r of view){
        const lat=Number(r.lat), lng=Number(r.lng); if(!lat||!lng) continue;
        const tot=Number(r.tot)||0, sbi=Number(r.sbi)||0, bemp=Number(r.bemp)||0, ratio=pct(sbi,tot), cls=ratioClass(ratio);
        const html = `<span class="pair"><b>${sbi}</b>/<b>${bemp}</b></span>`;
        const icon = L.divIcon({ className:`icon-dot ${cls}`, html, iconSize:[32,32], iconAnchor:[16,16]});
        const m = L.marker([lat,lng], { icon });
        const link = `https://www.google.com/maps?q=${lat},${lng}`;
        m.bindPopup(`<b>${r.sna}</b><br/>站號：${r.sno}<br/>行政區：${r.sarea}<br/>可借：${sbi}｜可還：${bemp}｜車柱：${tot}<br/>見車率：${Math.round(ratio)}%<br/>資料時間：${fmtTime(r.mday)}<br/><a href='${link}' target='_blank' rel='noopener'>在地圖開啟</a>`);
        m.addTo(markerLayer); markers.push([lat,lng]);
      }
      if(markers.length){ const b=L.latLngBounds(markers); map.fitBounds(b.pad(0.05)); }
    }

    // smoke tests
    (function(){ const r={sno:'0001',sna:'測試站',ar:'測試路1號'}; const hay=`${r.sno}|${r.sna}|${r.ar}`.toLowerCase(); console.assert(hay.includes('0001')&&hay.includes('測試站'),'pipe 測試'); })();
  });
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>新北市 YouBike 2.0｜即時場站資訊</h1>
      <div class="controls">
        <label class="search"><input id="q" placeholder="搜尋場站名稱 / 站點代號 / 地址…"/></label>
        <label class="district"><select id="district"><option value="">全部行政區</option></select></label>
        <label class="status"><select id="status"><option value="">全部狀態</option><option value="open">營運中</option><option value="closed">暫停營運</option></select></label>
        <label class="refresh"><select id="interval">
          <option value="30">每 30 秒自動更新</option>
          <option value="60" selected>每 60 秒自動更新</option>
          <option value="120">每 2 分鐘自動更新</option>
          <option value="0">手動</option>
        </select></label>
      </div>
      <div class="meta">
        <span id="lastUpdate" class="pill">最後更新：—</span>
        <span id="count" class="pill">筆數：—</span>
        <button id="manualBtn" class="pill button" title="立即更新">↻ 立即更新</button>
      </div>
      <div class="statusbar">
        <div>若顯示黑畫面，通常是 **Leaflet 尚未載入或 API 無回應**。本版已改為先載 Leaflet（defer），並在資料為 0 時自動改走代理。</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="map"></div>
    <div class="grid">
      <table>
        <thead>
          <tr>
            <th><button data-sort="sno">站點代號</button></th>
            <th><button data-sort="sna">場站</button></th>
            <th><button data-sort="sarea">行政區</button></th>
            <th><button data-sort="sbi">可借</button></th>
            <th><button data-sort="bemp">可還</button></th>
            <th><button data-sort="tot">車柱</button></th>
            <th><button data-sort="ratio">見車率</button></th>
            <th><button data-sort="mday">資料時間</button></th>
            <th>地址</th>
            <th><button data-sort="act">狀態</button></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="footer hidden">找不到符合條件的場站。</div>
      <div class="footer">資料來源：新北市政府資料開放平臺（每 5 分鐘更新）。</div>
    </div>
  </main>
</body>
</html>
